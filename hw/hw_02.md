## ДЗ 2

ДЗ Пошаговая инструкция:
1. открыть консоль и зайти по ssh на ВМ
2. открыть вторую консоль и также зайти по ssh на ту же ВМ (можно в докере 2 сеанса)
3. запустить везде psql из под пользователя postgres
4. сделать в первой сессии новую таблицу и наполнить ее данными
5. посмотреть текущий уровень изоляции:
6. начать новую транзакцию в обеих сессиях с дефолтным (не меняя) уровнем изоляции
7. в первой сессии добавить новую запись
8. сделать запрос на выбор всех записей во второй сессии
9. видите ли вы новую запись и если да то почему? После задания можете сверить правильный ответ с эталонным (будет доступен после 3 лекции)
10. завершить транзакцию в первом окне
11. сделать запрос на выбор всех записей второй сессии
12. видите ли вы новую запись и если да то почему?
13. завершите транзакцию во второй сессии
14. начать новые транзакции, но уже на уровне repeatable read в ОБЕИХ сессиях
15. в первой сессии добавить новую запись
16. сделать запрос на выбор всех записей во второй сессии
17. видите ли вы новую запись и если да то почему?
18. завершить транзакцию в первом окне
19. сделать запрос во выбор всех записей второй сессии
20. видите ли вы новую запись и если да то почему?

Докер компоуз с постгресом находится [здесь](../docker-compose.yaml)!

```sql
/*
заходим в консоль и там выполняем команды
docker compose up
docker exec -it postgres bash
su postgres
psql
*/


----------------------
-- терминал 1
----------------------

-- 4. сделать в первой сессии новую таблицу и наполнить ее данными
CREATE SCHEMA if not exists test;
drop table if exists test.hw2;
CREATE TABLE test.hw2 (id int);
INSERT INTO test.hw2 SELECT s.id FROM generate_series(1,5) AS s(id); 

-- 5. посмотреть текущий уровень изоляции:
show transaction isolation level;
/*
 transaction_isolation 
-----------------------
 read committed
(1 row)
*/

-- 6. начать новую транзакцию в обеих сессиях с дефолтным (не меняя) уровнем изоляции
-- 7. в первой сессии добавить новую запись
-- 8. сделать запрос на выбор всех записей во второй сессии

----------------------
-- терминал 2
----------------------
begin;

----------------------
-- терминал 1
----------------------
begin;
INSERT INTO test.hw2 values (6);

----------------------
-- терминал 2
----------------------
select * from test.hw2 ;
/*
 id 
----
  1
  2
  3
  4
  5
(5 rows)
*/

-- 9. видите ли вы новую запись и если да то почему? После задания можете сверить правильный ответ с эталонным (будет доступен после 3 лекции)
-- Мы не видим новую запись из-за уровня транзакции read committed. На этом уровне обеспечивается защита от чернового, грязного чтения. Транзакции видят только подтвержденные изменения других транзакций. Это предотвращает “грязное чтение”, но допускает “неповторяющееся чтение” (non-repeatable-read). Когда мы чуть дальше закоммитим транзакцию в первом терминале - запись станет видна


-- 10. завершить транзакцию в первом окне
-- 11. сделать запрос на выбор всех записей второй сессии

----------------------
-- терминал 1
----------------------
commit;
----------------------
-- терминал 2
----------------------
select * from test.hw2 ;
/*
 id 
----
  1
  2
  3
  4
  5
  6
(6 rows)
*/

-- 12. видите ли вы новую запись и если да то почему?
-- Мы видим новую запись (при роллбэке, естественно, не увидели бы). Как указано выше "Транзакции видят только подтвержденные изменения других транзакций". Даже с учетом того, что наша транзакция в терминале 2 была открыта до коммита транзакции в терминале 1 (на следующем уровне изоляции транзакций такое уже не прокатит, запись видна не будет)

-- 13. завершите транзакцию во второй сессии
commit;

-- 14. начать новые транзакции, но уже на уровне repeatable read в ОБЕИХ сессиях
-- 15. в первой сессии добавить новую запись
-- 16. сделать запрос на выбор всех записей во второй сессии

----------------------
-- в обоих сессиях
----------------------
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;

----------------------
-- терминал 1
----------------------
INSERT INTO test.hw2 values (7);
----------------------
-- терминал 2
----------------------
select * from test.hw2 ;
/*
 id 
----
  1
  2
  3
  4
  5
  6
(6 rows)
*/

-- 17. видите ли вы новую запись и если да то почему?
-- Запись не видна. В этом режиме транзакции видят только данные, которые были считаны на момент начала транзакции. Это предотвращает “грязное чтение” и “неповторяющееся чтение”, но может привести к “фантомным” записям, когда другая транзакция вставляет новые записи.

-- 18. завершить транзакцию в первом окне
-- 19. сделать запрос во выбор всех записей второй сессии
----------------------
-- терминал 1
----------------------
commit;
----------------------
-- терминал 2
----------------------
select * from test.hw2 ;
/*
 id 
----
  1
  2
  3
  4
  5
  6
(6 rows)
*/
-- 20. видите ли вы новую запись и если да то почему?
-- новая запись не видна, тк транзакция была открыта до коммита транзакции, в которой вставялась эта запись


```