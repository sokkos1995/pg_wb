## ДЗ 4

Протестировать падение производительности при использовании пгбаунсер в разных режимах - statement, transaction, session (даст ли какое то преимущество, можно сделать несколько запросов в одной транзакции или запрос посложнее)

Докер компоуз с постгресом находится [здесь](../docker-compose.yaml)!

### Setup

```bash
# поднимаем контейнер и ставим пгбаунсер
apt-get update
apt-get install vim systemctl pgbouncer
systemctl stop pgbouncer

# накатим тайские перевозки
su postgres
psql < /tmp/data/thai.sql

# сконфигурируем пгбаунсер
# pool_mode
cd /tmp/data/
cat > pgbouncer_ini.cfg << EOF 
[databases]
# подключаться будем к локалхосту тк ставим пгбаунсер на той же машине к базе тай
thai = host=127.0.0.1 port=5432 dbname=thai
# можем ограничить количество коннектов к баунсеру, к базе и прописать, под каким пользователем сколько коннектом разрешать
[pgbouncer]
logfile = /var/log/postgresql/pgbouncer.log
pidfile = /var/run/postgresql/pgbouncer.pid
listen_addr = *
listen_port = 6432
auth_type = scram-sha-256
# прописываем где файл аутентификации
auth_file = /etc/pgbouncer/userlist.txt
admin_users = admindb
EOF
cat pgbouncer_ini.cfg | tee -a /etc/pgbouncer/pgbouncer.ini

cat > pgbouncer_userlist.cfg << EOF 
"admindb" "admin123#"
"postgres" "admin123#"
EOF
cat pgbouncer_userlist.cfg | tee -a /etc/pgbouncer/userlist.txt

# зададим пароль юзеру postgres
su postgres
psql -c "ALTER USER postgres WITH PASSWORD 'admin123#';"
psql -c "create user admindb with password 'admin123#';"

## запускаем пгбаунсер и убеждаемся что все ок
systemctl start pgbouncer
systemctl status pgbouncer

# напишем запросы для разных режимов
cat > ~/statement_query.sql << EOL
\set r random(1, 5000000) 
SELECT id, fkRide, fio, contact, fkSeat FROM book.tickets WHERE id = :r;
EOL
cat > ~/transaction_query.sql << EOL
\set r random(1, 5000000) 
begin;
create table if not exists test_transaction (id int);
SELECT id, fkRide, fio, contact, fkSeat FROM book.tickets WHERE id = :r;
insert into test_transaction values (:r);
commit;
EOL
cat > ~/session_query.sql << EOL
\set r random(1, 5000000) 
begin;
create table if not exists test_session (id int);
SELECT id, fkRide, fio, contact, fkSeat FROM book.tickets WHERE id = :r;
insert into test_session values (:r);
commit;
begin;
SELECT id, fkRide, fio, contact, fkSeat FROM book.tickets WHERE id = :r;
insert into test_session values (:r * -1);
commit;
EOL


# сравнение
/usr/lib/postgresql/17/bin/pgbench -c 8 -j 4 -T 10 -f ~/workload.sql -n -U postgres thai
```